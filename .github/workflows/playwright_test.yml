name: Playwright Web Automation Framework

on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to run tests on'
        required: false
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox

jobs:
  run-e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.11.0

      - name: Install root dependencies only
        working-directory: ./playwright_web
        run: npm install

      - name: Install Playwright Browsers
        working-directory: ./playwright_web
        run: npm exec playwright install --with-deps

      - name: Run Playwright tests
        working-directory: ./playwright_web
        run: npx playwright test --project=${{ github.event.inputs.browser || 'chrome' }}

      # - name: Upload Playwright HTML report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: playwright-report
      #     path: playwright_web/playwright-report
      
      - name: Upload Playwright Report to Github Pages
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: playwright_web/playwright-report/

      - name: Publish Test Report
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: 'playwright_web/ctrf/ctrf-report.json'
          summary-report: true
          github-report: true
          test-report: true
          test-list-report: true
          failed-report: true
          fail-rate-report: true
          flaky-report: true
          flaky-rate-report: true
          failed-folded-report: true
          previous-results-report: true
          insights-report: true
          slowest-report: true
          ai-report: true
          skipped-report: true
          suite-folded-report: true
          suite-list-report: true
          file-report: true
          pull-request-report: true
          commit-report: true
          custom-report: true
          community-report: true
        if: always()

  deploy:
    if: always()
    needs: run-e2e-tests
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
